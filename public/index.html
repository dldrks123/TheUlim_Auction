<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheUlim Auction (LoL Draft)</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* â­ UI ìˆ˜ì •: ê²½ë§¤ ìˆœì„œë¥¼ ì™¼ìª½ í•˜ë‹¨ìœ¼ë¡œ ì´ë™ ë° ì „ì²´ ë ˆì´ì•„ì›ƒ ì¡°ì • */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .main-container { max-width: 1400px; /* ì „ì²´ ë„ˆë¹„ ì•½ê°„ í™•ì¥ */ margin: auto; display: flex; gap: 20px; }
        .left-panel { flex: 3; /* ë©”ì¸/ìˆœì„œ íŒ¨ë„ */ }
        .right-panel { flex: 2; /* í”Œë ˆì´ì–´ ìƒíƒœ íŒ¨ë„ */ }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #007bff; text-align: center; margin-bottom: 20px;}
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-bottom: 15px; }
        .lobby, .auction { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .player-list { list-style: none; padding: 0; }
        .player-list li { margin-bottom: 5px; padding: 8px; background: #eee; border-radius: 3px; }
        .ready-btn { background-color: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        
        .auction-info { border: 2px solid #007bff; padding: 15px; margin-bottom: 15px; background: #e9f7ff; }
        #timer { font-size: 2em; font-weight: bold; color: #dc3545; }
        #log { margin-top: 20px; padding: 10px; background: #f9f9f9; max-height: 200px; overflow-y: scroll; border: 1px solid #ccc; }
        
        /* ì…ì°° ë²„íŠ¼ ê·¸ë£¹ */
        .bid-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px;}
        .bid-controls input[type="number"] { padding: 8px; width: 100px; text-align: right; }
        .bid-controls button { padding: 10px 15px; font-weight: bold; cursor: pointer; border: none; border-radius: 5px; }
        .bid-controls .bid-btn-inc { background-color: #ffc107; color: #333; }
        .bid-controls .bid-btn-main { background-color: #007bff; color: white; }
        .bid-controls button:disabled { background-color: #ccc; cursor: not-allowed; } 

        /* í”Œë ˆì´ì–´ ìƒíƒœ UI */
        .player-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .current-bidder { border: 2px solid #ffc107; background-color: #fff8e1 !important; } 
        .roster-list { font-size: 0.9em; margin-top: 5px; }
        
        /* ê²½ë§¤ ìˆœì„œ UI (ì™¼ìª½ íŒ¨ë„ë¡œ ì´ë™) */
        .auction-status-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .auction-item-list { list-style: none; padding: 0; font-size: 0.9em; max-height: 300px; overflow-y: auto; }
        .auction-item-list li { padding: 5px; border-bottom: 1px dotted #eee; }
        .item-status-ACQUIRED { color: green; font-weight: bold; }
        .item-status-FAILED { color: orange; }
        .item-status-UNSOLD { color: #333; }

        /* íŠ¸ëœì§€ì…˜ UI */
        #transition-box { 
            border: 3px dashed #007bff; 
            padding: 15px; 
            margin-bottom: 15px; 
            text-align: center;
            background: #e9f7ff;
        }
        #transition-timer { font-size: 3em; font-weight: bold; color: #dc3545; }
        #next-item-preview { margin-top: 10px; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="main-container">
        
        <div class="left-panel">
            <div class="container">
                <h1>TheUlim Auction ğŸš€</h1>
                <p>ì ‘ì†ì: <span id="my-id"></span></p>
                <p>ë‚´ ë‚¨ì€ í¬ì¸íŠ¸: <span id="my-points">1000</span>p</p>

                <div class="lobby" id="lobby-section">
                    <h2>ë¡œë¹„</h2>
                    <p>
                        ë‹‰ë„¤ì„: <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”">
                        <button onclick="setNickname()">ë³€ê²½</button>
                    </p>
                    <h3>ì ‘ì† í˜„í™© (3/3ëª… í•„ìš”)</h3>
                    <ul id="player-list" class="player-list"></ul>
                    <button class="ready-btn" id="ready-btn" onclick="sendReady()">ì¤€ë¹„ ì™„ë£Œ</button>
                    <p id="lobby-status"></p>
                </div>

                <div class="auction" id="auction-section" style="display: none;">
                    
                    <div id="transition-box" style="display: none;">
                        <h3>ê²½ë§¤ ì¢…ë£Œ! ì ì‹œ í›„ ë‹¤ìŒ ë§¤ë¬¼ì´ ì‹œì‘ë©ë‹ˆë‹¤.</h3>
                        <p id="transition-timer">5</p>
                        <p id="next-item-preview">ë‹¤ìŒ ì„ ìˆ˜: --</p>
                    </div>

                    <h2>í˜„ì¬ ê²½ë§¤</h2>
                    <div class="auction-info">
                        <p>ë‚¨ì€ ì‹œê°„: <span id="timer">--</span>ì´ˆ</p>
                        <p>ì„ ìˆ˜: <span id="item-name">--</span> (<span id="item-position">--</span>)</p>
                        <p>í˜„ì¬ê°€: <span id="current-price">0</span> í¬ì¸íŠ¸</p>
                        <p>ìµœê³  ì…ì°°ì: <span id="top-bidder">ì—†ìŒ</span></p>
                        <p id="min-bid-info">ìµœì†Œ ì…ì°° ê°€ëŠ¥ ê¸ˆì•¡: 10p</p>
                    </div>
                    
                    <div class="bid-controls" id="bid-controls">
                        <button class="bid-btn-inc" onclick="decreaseBid(10)">-10</button>
                        <button class="bid-btn-inc" onclick="decreaseBid(50)">-50</button>
                        <button class="bid-btn-inc" onclick="decreaseBid(100)">-100</button>

                        <input type="number" id="bid-input" placeholder="ì§ì ‘ ì…ë ¥" value="10"> 
                        
                        <button class="bid-btn-inc" onclick="increaseBid(10)">+10</button>
                        <button class="bid-btn-inc" onclick="increaseBid(50)">+50</button>
                        <button class="bid-btn-inc" onclick="increaseBid(100)">+100</button>
                        
                        <button class="bid-btn-main" onclick="sendBid()">ì…ì°°í•˜ê¸°</button>
                    </div>

                    <h3>ê²½ë§¤ ë¡œê·¸</h3>
                    <div id="log"></div>
                </div>
            </div>
            
            <div class="auction-status-container">
                <h2>ê²½ë§¤ ìˆœì„œ ë° í˜„í™© (ì´ 12ëª…)</h2>
                <ul id="auction-status-list" class="auction-item-list">
                    </ul>
            </div>
        </div>

        <div class="right-panel">
            <div class="container">
                <h2>í”Œë ˆì´ì–´ ìƒíƒœ</h2>
                <div id="player-status-panel">
                    </div>
            </div>
        </div>
    </div>


    <script>
        const socket = io();
        let myId = '';
        let myNickname = 'P?';
        let currentItemId = null;
        let myPoints = 1000;
        let currentBidPrice = 0; 
        const MIN_START_BID = 10; 

        // --- UI ìš”ì†Œ ë§µí•‘ ---
        const lobbySection = document.getElementById('lobby-section');
        const auctionSection = document.getElementById('auction-section');
        const nicknameInput = document.getElementById('nickname-input');
        const playerList = document.getElementById('player-list');
        const log = document.getElementById('log');
        const myPointsDisplay = document.getElementById('my-points');
        const playerStatusPanel = document.getElementById('player-status-panel');
        const auctionStatusList = document.getElementById('auction-status-list');

        const timerDisplay = document.getElementById('timer');
        const itemNameDisplay = document.getElementById('item-name');
        const itemPositionDisplay = document.getElementById('item-position');
        const currentPriceDisplay = document.getElementById('current-price');
        const topBidderDisplay = document.getElementById('top-bidder');
        const bidInput = document.getElementById('bid-input');
        const readyBtn = document.getElementById('ready-btn');
        const lobbyStatus = document.getElementById('lobby-status');
        const minBidInfo = document.getElementById('min-bid-info');
        const bidControls = document.getElementById('bid-controls');
        const transitionBox = document.getElementById('transition-box');
        const transitionTimer = document.getElementById('transition-timer');
        const nextItemPreview = document.getElementById('next-item-preview');


        // --- í—¬í¼ í•¨ìˆ˜ ---
        
        function updateMinBidInfo(currentPrice) {
            const requiredPrice = currentPrice === 0 ? MIN_START_BID : currentPrice + 10;
            minBidInfo.textContent = `ìµœì†Œ ì…ì°° ê°€ëŠ¥ ê¸ˆì•¡: ${requiredPrice}p`;
        }

        function setBidControlsDisabled(disabled) {
            const buttons = bidControls.querySelectorAll('button');
            const input = bidControls.querySelector('input');
            buttons.forEach(btn => btn.disabled = disabled);
            input.disabled = disabled;
            if (!disabled) {
                const requiredPrice = currentBidPrice === 0 ? MIN_START_BID : currentBidPrice + 10;
                bidInput.value = requiredPrice;
            }
        }

        // --- SOCKET ìˆ˜ì‹  ì²˜ë¦¬ ---

        socket.on('player_info', (data) => {
            myId = data.id;
            myNickname = data.nickname;
            document.getElementById('my-id').textContent = myNickname;
            nicknameInput.value = myNickname;
        });

        socket.on('lobby_update', (data) => {
            playerList.innerHTML = '';
            data.players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = `${p.nickname} [${p.ready ? 'âœ… ì¤€ë¹„ë¨' : 'âŒ ë¯¸ì¤€ë¹„'}]`;
                playerList.appendChild(li);
            });
        });

        socket.on('game_start', (message) => {
            logMessage(`[ì‹œìŠ¤í…œ] ${message}`, 'green');
            lobbySection.style.display = 'none';
            auctionSection.style.display = 'block';
        });

        socket.on('game_update', (data) => {
            logMessage(`[ì‹œìŠ¤í…œ] ${data.message}`, 'blue');
            
            if (data.message.includes('ë¡œë¹„ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤')) {
                lobbySection.style.display = 'block';
                auctionSection.style.display = 'none';
                readyBtn.disabled = false;
                lobbyStatus.textContent = '';
                // ê²½ë§¤ ê´€ë ¨ UI ì´ˆê¸°í™”
                itemNameDisplay.textContent = '--';
                itemPositionDisplay.textContent = '--';
                currentPriceDisplay.textContent = '0';
                topBidderDisplay.textContent = 'ì—†ìŒ';
            }
        });

        // íŠ¸ëœì§€ì…˜ ì‹œì‘ (5ì´ˆ ëŒ€ê¸°)
        socket.on('transition_start', (data) => {
            transitionBox.style.display = 'block';
            timerDisplay.textContent = '--';
            setBidControlsDisabled(true); // ì…ì°° ë²„íŠ¼ ë¹„í™œì„±í™”

            const status = data.currentItem.status === 'ACQUIRED' ? 'ë‚™ì°°' : 'ìœ ì°°';
            const itemInfo = `${data.currentItem.name} (${data.currentItem.position}) ${status}ë¨`;
            logMessage(`[ëŒ€ê¸°] ${itemInfo}. 5ì´ˆ í›„ ë‹¤ìŒ ë§¤ë¬¼ì´ ì‹œì‘ë©ë‹ˆë‹¤.`, 'purple');
            
            transitionTimer.textContent = data.countdown;
            nextItemPreview.textContent = `ë‹¤ìŒ ì„ ìˆ˜: ${data.nextItem.name} (${data.nextItem.position})`;

            // í˜„ì¬ ê²½ë§¤ ì •ë³´ ì´ˆê¸°í™”
            currentItemId = null;
            currentBidPrice = 0; 
            itemNameDisplay.textContent = '--';
            itemPositionDisplay.textContent = '--';
            currentPriceDisplay.textContent = currentBidPrice;
            topBidderDisplay.textContent = 'ì—†ìŒ';
            updateMinBidInfo(currentBidPrice);
        });

        // íŠ¸ëœì§€ì…˜ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        socket.on('transition_update', (data) => {
            transitionTimer.textContent = data.countdown;
            if (data.countdown <= 0) {
                transitionBox.style.display = 'none';
                setBidControlsDisabled(false); // ì…ì°° ë²„íŠ¼ í™œì„±í™”
            }
        });

        socket.on('auction_start', (item) => {
            currentItemId = item.id;
            currentBidPrice = 0; 
            itemNameDisplay.textContent = item.name;
            itemPositionDisplay.textContent = item.position;
            currentPriceDisplay.textContent = currentBidPrice;
            topBidderDisplay.textContent = 'ì—†ìŒ';
            updateMinBidInfo(currentBidPrice);
            
            logMessage(`[ê²½ë§¤ ì‹œì‘] ${item.name} (${item.position})`, 'blue');
        });

        socket.on('update_timer', (data) => {
            timerDisplay.textContent = data.time;
        });

        socket.on('update_bid', (data) => {
            currentBidPrice = data.price; 
            currentPriceDisplay.textContent = data.price;
            topBidderDisplay.textContent = data.bidder;
            updateMinBidInfo(currentBidPrice); 
            
            logMessage(`[ì…ì°°] ${data.bidder}: ${data.price} í¬ì¸íŠ¸`, 'orange');
        });

        socket.on('auction_result', (data) => {
            if (data.status === 'ACQUIRED') {
                logMessage(`ğŸ† [ë‚™ì°°] ${data.item.name}ì´(ê°€) ${data.item.finalPrice}ì— ${data.winner}ì—ê²Œ ë‚™ì°°ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'red');
            } else if (data.status === 'FAILED') {
                logMessage(`ğŸš« [ìœ ì°°] ${data.item.name}ì€ ìœ ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'gray');
            }
            timerDisplay.textContent = '--';
        });

        socket.on('auto_acquisition', (data) => {
            logMessage(`â­ [ìë™ ë‚™ì°°] ${data.item.name} (${data.item.position}) ì„ ìˆ˜ê°€ ${data.winner}ì—ê²Œ 0ì›ì— ìë™ ë‚™ì°°ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'purple');
        });
        
        socket.on('error_message', (message) => {
            logMessage(`[ì˜¤ë¥˜] ${message}`, 'red');
        });
        
        // í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ (í¬ì¸íŠ¸, ë¡œìŠ¤í„°)
        socket.on('player_status_update', (playerStatuses) => {
            playerStatusPanel.innerHTML = '';
            playerStatuses.forEach(p => {
                if (p.id === myId) {
                    myPoints = p.points;
                    myPointsDisplay.textContent = p.points;
                }

                const card = document.createElement('div');
                card.className = 'player-card';
                if (p.isTopBidder) {
                    card.classList.add('current-bidder');
                } else if (p.id === myId) {
                    card.style.backgroundColor = '#e0f7fa'; 
                }

                let rosterHtml = p.roster.length > 0 
                    ? p.roster.map(item => `<li>${item.name} (${item.position}, ${item.price}p)</li>`).join('')
                    : '<li>(íšë“í•œ ì„ ìˆ˜ ì—†ìŒ)</li>';

                card.innerHTML = `
                    <strong>${p.nickname} ${p.id === myId ? '(ë‚˜)' : ''}</strong>
                    <p>ì”ì—¬ í¬ì¸íŠ¸: <strong>${p.points}p</strong></p>
                    <div class="roster-list">
                        <small>íšë“ ì„ ìˆ˜:</small>
                        <ul style="list-style-type: none; padding-left: 10px;">${rosterHtml}</ul>
                    </div>
                `;
                playerStatusPanel.appendChild(card);
            });
        });

        // ì „ì²´ ê²½ë§¤ í˜„í™© ì—…ë°ì´íŠ¸ (12ëª… ëª©ë¡)
        socket.on('auction_status_update', (auctionStatus) => {
            auctionStatusList.innerHTML = '';
            auctionStatus.forEach(item => {
                const li = document.createElement('li');
                
                let statusText = '';
                let statusClass = `item-status-${item.status}`;

                if (item.status === 'ACQUIRED') {
                    statusText = 'ë‚™ì°°ë¨';
                } else if (item.status === 'FAILED') {
                    statusText = 'ìœ ì°°';
                } else {
                    statusText = 'ê²½ë§¤ ì˜ˆì •/ì¤‘';
                    
                    if(item.sequence === (auctionStatus.findIndex(i => i.status === 'UNSOLD' || i.status === 'FAILED') + 1)) {
                         statusText = 'â­ ê²½ë§¤ ì¤‘';
                         statusClass += ' item-status-current';
                    }
                }

                li.className = statusClass;
                li.innerHTML = `(${item.sequence}) <strong>${item.name}</strong> (${item.position}) - ${statusText}`; 
                auctionStatusList.appendChild(li);
            });
        });


        // --- SOCKET ì†¡ì‹  ì²˜ë¦¬ (í´ë¦­ ì´ë²¤íŠ¸ì™€ ì—°ê²°ë¨) ---

        function setNickname() {
            const nickname = nicknameInput.value.trim();
            if (nickname) {
                socket.emit('set_nickname', nickname);
                myNickname = nickname;
            }
        }

        function sendReady() {
            socket.emit('ready');
            readyBtn.disabled = true;
            lobbyStatus.textContent = 'ì¤€ë¹„ ì™„ë£Œ ëŒ€ê¸° ì¤‘...';
        }

        // ì…ì°° ê¸ˆì•¡ ì¦ê°€ ê¸°ëŠ¥
        function increaseBid(amount) {
            let currentInput = parseInt(bidInput.value) || 0;
            let newPrice = currentInput + amount;
            
            const minRequired = currentBidPrice === 0 ? MIN_START_BID : currentBidPrice + 10;
            
            newPrice = Math.ceil(newPrice / 10) * 10;
            
            if (newPrice < minRequired) {
                newPrice = minRequired;
            }

            bidInput.value = newPrice;
        }

        // ì…ì°° ê¸ˆì•¡ ê°ì†Œ ê¸°ëŠ¥
        function decreaseBid(amount) {
            let currentInput = parseInt(bidInput.value) || 0;
            let newPrice = currentInput - amount;
            
            const minRequired = currentBidPrice === 0 ? MIN_START_BID : currentBidPrice + 10;
            
            if (newPrice < minRequired) {
                newPrice = minRequired;
            }

            newPrice = Math.ceil(newPrice / 10) * 10;

            bidInput.value = newPrice;
        }


        function sendBid() {
            const price = parseInt(bidInput.value);
            
            if (price > myPoints) {
                logMessage(`[ì˜¤ë¥˜] ë³´ìœ  í¬ì¸íŠ¸(${myPoints}p)ë³´ë‹¤ ë†’ì€ ê¸ˆì•¡(${price}p)ìœ¼ë¡œ ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'red');
                return;
            }
            
            if (price && currentItemId) {
                socket.emit('bid', price);
            } else {
                alert('ìœ íš¨í•œ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
            }
        }

        // --- ê¸°íƒ€ UI í•¨ìˆ˜ ---
        function logMessage(message, color) {
            const p = document.createElement('p');
            p.textContent = message;
            p.style.color = color;
            log.prepend(p);
        }

        // Global exposure
        window.setNickname = setNickname;
        window.sendReady = sendReady;
        window.sendBid = sendBid;
        window.increaseBid = increaseBid;
        window.decreaseBid = decreaseBid; 
    </script>
</body>
</html>